# Upstream Service Definitions
# CareForAll Donation Platform

# API Gateway (single container) - Main entry point
upstream api_gateway {
    keepalive 32;
    keepalive_timeout 60s;
    keepalive_requests 100;

    server api-gateway:3000 max_fails=3 fail_timeout=30s weight=1;
    
    # Health check (requires nginx-plus or third-party module)
    # health_check interval=10s fails=3 passes=2;
}

# Auth Service (single container)
upstream auth_service {
    keepalive 16;

    server auth-service:3001 max_fails=3 fail_timeout=30s;
}

# Campaign Service (single container)
upstream campaign_service {
    keepalive 16;

    server campaign-service:3002 max_fails=3 fail_timeout=30s;
}

# Pledge Service (single container)
upstream pledge_service {
    keepalive 24;

    server pledge-service:3003 max_fails=3 fail_timeout=30s;
}

# Payment Service (single container) - Critical service
upstream payment_service {
    keepalive 24;
    keepalive_timeout 90s;

    server payment-service:3004 max_fails=2 fail_timeout=60s weight=1;
    
    # Longer fail timeout for payment service due to critical nature
}

# Totals Service (single container)
upstream totals_service {
    keepalive 16;

    server totals-service:3005 max_fails=3 fail_timeout=30s;
}

# Notification Service (single container)
upstream notification_service {
    keepalive 8;

    server notification-service:3006 max_fails=3 fail_timeout=30s;
}

# Admin Service (single container)
upstream admin_service {
    keepalive 8;

    server admin-service:3007 max_fails=3 fail_timeout=30s;
}

# Wallet Service (Mock Payment Gateway)
upstream wallet_service {
    keepalive 16;
    keepalive_timeout 90s;

    server wallet-service:4000 max_fails=2 fail_timeout=60s weight=1;
}

# Frontend Service
upstream frontend {
    server frontend:80 max_fails=2 fail_timeout=10s;
    keepalive 8;
}
