# CareForAll Donation Platform - Docker Compose Configuration
# Microservices Architecture with Load Balancing

version: '3.8'

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
  monitoring:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  prometheus_data:
  grafana_data:
  loki_data:
  alertmanager_data:
  nginx_cache:

services:
  # ============================================
  # LOAD BALANCER - NGINX
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: nginx-load-balancer
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/logs:/var/log/nginx
      - nginx_cache:/var/cache/nginx  # Cache directory for proxy caching
    depends_on:
      - api-gateway
      - frontend
    networks:
      - frontend
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # FRONTEND
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    environment:
      - NODE_ENV=production
      # Frontend runs in browser, so it needs the public URL (not container name)
      # Use localhost for development, replace with actual domain in production
      - REACT_APP_API_URL=http://localhost
    networks:
      - frontend
    restart: unless-stopped

  # ============================================
  # API GATEWAY (single container)
  # ============================================
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    environment:
      - NODE_ENV=production
      - PORT=3000
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - AUTH_SERVICE_URL=http://auth-service:3001
      - CAMPAIGN_SERVICE_URL=http://campaign-service:3002
      - PLEDGE_SERVICE_URL=http://pledge-service:3003
      - PAYMENT_SERVICE_URL=http://payment-service:3004
      - TOTALS_SERVICE_URL=http://totals-service:3005
      - NOTIFICATION_SERVICE_URL=http://notification-service:3006
      - ADMIN_SERVICE_URL=http://admin-service:3007
      - WALLET_SERVICE_URL=http://wallet-service:4000
    depends_on:
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # AUTH SERVICE (single container)
  # ============================================
  auth-service:
    build:
      context: ./authentication
      dockerfile: Dockerfile
    container_name: auth-service
    environment:
      - NODE_ENV=production
      - PORT=3001
      - MONGODB_URI=mongodb://mongodb:27017/auth-db
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - JWT_EXPIRES_IN=7d
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # CAMPAIGN SERVICE (single container)
  # ============================================
  campaign-service:
    build:
      context: ./campaign
      dockerfile: Dockerfile
    container_name: campaign-service
    environment:
      - NODE_ENV=production
      - PORT=3002
      - MONGODB_URI=mongodb://mongodb:27017/campaign-db
      - REDIS_URL=redis://redis:6379
      - BULLMQ_REDIS_HOST=redis
      - BULLMQ_REDIS_PORT=6379
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # PLEDGE SERVICE (single container)
  # ============================================
  pledge-service:
    build:
      context: ./pledge
      dockerfile: Dockerfile
    container_name: pledge-service
    environment:
      - NODE_ENV=production
      - PORT=3003
      - MONGODB_URI=mongodb://mongodb:27017/pledge-db
      - REDIS_URL=redis://redis:6379
      - BULLMQ_REDIS_HOST=redis
      - BULLMQ_REDIS_PORT=6379
      - PAYMENT_SERVICE_URL=http://payment-service:3004
      - ENABLE_SCHEDULER=true
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # PAYMENT SERVICE (single container)
  # ============================================
  payment-service:
    build:
      context: ./payment
      dockerfile: Dockerfile
    container_name: payment-service
    environment:
      - NODE_ENV=production
      - PORT=3004
      - MONGODB_URI=mongodb://mongodb:27017/payment-db
      - REDIS_URL=redis://redis:6379
      - BULLMQ_REDIS_HOST=redis
      - BULLMQ_REDIS_PORT=6379
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-webhook-secret-change-in-production}
      - WALLET_SERVICE_URL=http://wallet-service:4000
      - BKASH_API_URL=${BKASH_API_URL:-}
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      - SSL_COMMERZ_API_URL=${SSL_COMMERZ_API_URL:-}
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # TOTALS SERVICE (single container)
  # ============================================
  totals-service:
    build:
      context: ./totals
      dockerfile: Dockerfile
    container_name: totals-service
    environment:
      - NODE_ENV=production
      - PORT=3005
      - MONGODB_URI=mongodb://mongodb:27017/totals-db
      - REDIS_URL=redis://redis:6379
      - BULLMQ_REDIS_HOST=redis
      - BULLMQ_REDIS_PORT=6379
      - ENABLE_WORKER=true
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3005/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # NOTIFICATION SERVICE (single container)
  # ============================================
  notification-service:
    build:
      context: ./notification
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      - NODE_ENV=production
      - PORT=3006
      - MONGODB_URI=mongodb://mongodb:27017/notification-db
      - REDIS_URL=redis://redis:6379
      - BULLMQ_REDIS_HOST=redis
      - BULLMQ_REDIS_PORT=6379
      - SMTP_HOST=${SMTP_HOST:-smtp.mailtrap.io}
      - SMTP_PORT=${SMTP_PORT:-2525}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMS_API_KEY=${SMS_API_KEY:-}
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # ADMIN SERVICE (single container)
  # ============================================
  admin-service:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: admin-service
    environment:
      - NODE_ENV=production
      - PORT=3007
      - MONGODB_URI=mongodb://mongodb:27017/admin-db
      - REDIS_URL=redis://redis:6379
      - CAMPAIGN_SERVICE_URL=http://campaign-service:3002
      - PLEDGE_SERVICE_URL=http://pledge-service:3003
      - PAYMENT_SERVICE_URL=http://payment-service:3004
    depends_on:
      - mongodb
      - redis
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3007/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ============================================
  # WALLET SERVICE (Mock Payment Gateway)
  # ============================================
  wallet-service:
    build:
      context: ./wallet
      dockerfile: Dockerfile
    container_name: wallet-service
    ports:
      - "9001:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - MONGODB_URI=mongodb://mongodb:27017/wallet-db
      - PAYMENT_SERVICE_URL=http://payment-service:3004
      - SESSION_SECRET=${SESSION_SECRET:-default-secret-change-in-production}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-default-webhook-secret-change-in-production}
      - BCRYPT_ROUNDS=10
      - TRANSACTION_EXPIRY_HOURS=1
      - CALLBACK_RETRY_ATTEMPTS=3
      - CALLBACK_RETRY_DELAY_MS=1000
      - LOG_LEVEL=info
      - CORS_ORIGIN=*
    depends_on:
      - mongodb
    networks:
      - backend
    volumes:
      - ./wallet/logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # DATABASES & MESSAGE QUEUE
  # ============================================
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-changeme}
    volumes:
      - mongodb_data:/data/db
      - ./init-scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================
  # OBSERVABILITY - MONITORING STACK
  # ============================================
  
  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    networks:
      - backend
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Alertmanager - Alert Management
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    ports:
      - "9093:9093"
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
    volumes:
      - ./observability/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3200:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
    volumes:
      - grafana_data:/var/lib/grafana
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./observability/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
      - loki
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Loki - Log Aggregation (lightweight alternative to Elasticsearch)
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./observability/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Promtail - Log Collector for Loki
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - ./observability/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - monitoring
    depends_on:
      - loki
    restart: unless-stopped

  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"
      - "14250:14250"
      - "9411:9411"
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - backend
      - monitoring
    restart: unless-stopped

  # Node Exporter - System Metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    command:
      - '--path.rootfs=/host'
    ports:
      - "9100:9100"
    volumes:
      - '/:/host:ro,rslave'
    networks:
      - monitoring
    restart: unless-stopped

  # cAdvisor - Container Metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    privileged: true
    networks:
      - monitoring
    restart: unless-stopped

  # MongoDB Exporter - MongoDB Metrics
  mongodb-exporter:
    image: percona/mongodb_exporter:0.40
    container_name: mongodb-exporter
    ports:
      - "9216:9216"
    environment:
      - MONGODB_URI=mongodb://admin:${MONGO_PASSWORD:-changeme}@mongodb:27017
    command:
      - '--mongodb.uri=mongodb://admin:${MONGO_PASSWORD:-changeme}@mongodb:27017'
      - '--mongodb.direct-connect=true'
      - '--collect-all'
      - '--compatible-mode'
    depends_on:
      - mongodb
    networks:
      - backend
      - monitoring
    restart: unless-stopped

  # Redis Exporter - Redis Metrics
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    ports:
      - "9121:9121"
    environment:
      - REDIS_ADDR=redis://redis:6379
      - REDIS_EXPORTER_INCL_SYSTEM_METRICS=true
    depends_on:
      - redis
    networks:
      - backend
      - monitoring
    restart: unless-stopped

  # NGINX Prometheus Exporter
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: nginx-exporter
    ports:
      - "9113:9113"
    command:
      - '-nginx.scrape-uri=http://nginx/nginx_status'
    depends_on:
      - nginx
    networks:
      - frontend
      - monitoring
    restart: unless-stopped

  # ============================================
  # OBSERVABILITY SERVICE (Event Consumer & Log Processor)
  # ============================================
  observability-service:
    build:
      context: ./observability
      dockerfile: Dockerfile
    container_name: observability-service
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - BULLMQ_REDIS_HOST=redis
      - BULLMQ_REDIS_PORT=6379
      - LOKI_URL=http://loki:3100
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - PROMETHEUS_URL=http://prometheus:9090
    depends_on:
      - redis
      - loki
      - jaeger
      - prometheus
    networks:
      - backend
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3008/health"]
      interval: 15s
      timeout: 5s
      retries: 3
